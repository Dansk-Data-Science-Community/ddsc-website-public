name: Deploy to Azure Container Apps (Production)

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual trigger

env:
  AZURE_CONTAINER_REGISTRY: ddscacrprod
  RESOURCE_GROUP: rg-ddsc-prod
  WEB_APP_NAME: ddsc-web-prod
  CELERY_APP_NAME: ddsc-celery-prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Log in to Azure Container Registry
      run: |
        az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

    - name: Set image tag
      id: set-tag
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          echo "IMAGE_TAG=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        else
          echo "IMAGE_TAG=$(date +%Y%m%d-%H%M%S)-${{ github.sha }}" >> $GITHUB_OUTPUT
        fi

    - name: Build and push web Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/ddsc-web:${{ steps.set-tag.outputs.IMAGE_TAG }}
          ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/ddsc-web:latest
        cache-from: type=registry,ref=${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/ddsc-web:latest
        cache-to: type=inline

    - name: Build and push Celery Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.celery
        push: true
        tags: |
          ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/ddsc-celery:${{ steps.set-tag.outputs.IMAGE_TAG }}
          ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/ddsc-celery:latest
        cache-from: type=registry,ref=${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/ddsc-celery:latest
        cache-to: type=inline

    - name: Update web container app
      run: |
        az containerapp update \
          --name ${{ env.WEB_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/ddsc-web:${{ steps.set-tag.outputs.IMAGE_TAG }}

    - name: Update Celery container app (if exists)
      run: |
        if az containerapp show --name ${{ env.CELERY_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} &> /dev/null; then
          az containerapp update \
            --name ${{ env.CELERY_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/ddsc-celery:${{ steps.set-tag.outputs.IMAGE_TAG }}
          echo "Celery worker updated"
        else
          echo "Celery worker does not exist, skipping"
        fi

    - name: Run database migrations
      run: |
        az containerapp exec \
          --name ${{ env.WEB_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --command "python manage.py migrate --noinput --settings=ddsc_web.settings.azure"

    - name: Collect static files
      run: |
        az containerapp exec \
          --name ${{ env.WEB_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --command "python manage.py collectstatic --noinput --settings=ddsc_web.settings.azure" || echo "Collectstatic failed, continuing..."

    - name: Get deployment URL
      run: |
        APP_URL=$(az containerapp show \
          --name ${{ env.WEB_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          --output tsv)
        echo "üöÄ Application deployed successfully!"
        echo "üåê URL: https://$APP_URL"
        echo "üì¶ Image Tag: ${{ steps.set-tag.outputs.IMAGE_TAG }}"

    - name: Logout from Azure
      run: |
        az logout
      if: always()
